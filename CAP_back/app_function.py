companies = {
    "SK": [
        {
            "title": "Application Engineering",
            "required_skills": ["java", "springboot", "sql"],
            "experience" : "신입",
            "preferential": ["프로그래밍 언어 및 DB 활용", "MSA", "AWS Resource", "Native App."]
        },
        {
            "title": "SoftWare Engineering",
            "required_skills": ["java", "springboot"],
            "experience" : "신입",
            "preferential": ["금융 및 경제학 관련 지식", "Native App. 개발"]
        }
    ],
    "Toss": [
        {
            "title": "Server Developer",
            "required_skills": ["java", "spring framework"],
            "experience" : "신입",
            "preferential": ["redis", "kafka", "elk", "네트워크프로그래밍"]
        },
        {
            "title": "iOS Developer",
            "required_skills": ["object-C", "swift"],
            "experience" : "신입",
            "preferential": ["SDK 개발"]
        }
    ],
    "Coupang": [
        {
            "title": "Senior, Backend engineer (SCM)",
            "required_skills": ["java", "python", "spring"],
            "experience": "5",
            "preferential": ["Spring boot", "컴퓨터 과학 석사학위"]
        }
    ],
    "Saltlux": [
        {
            "title": "Web_Developer",
            "required_skills": ["java", "jsp"],
            "experience" : "신입",
            "preferential": ["정보처리기사", "챗봇구축경험자"]
        }
    ],
    "Wins" : [
        {
            "title" : "SW Developer",
            "required_skills" : ["java", "rdb", "nosql"],
            "experience" : "신입",
            "preferential" : ["Elastic Search", "python", "hadoop"],
        }
    ],
    "삼진" : [
        {
            "title" : "Embedded SW Developer",
            "required_skills" : ["c", "c++"],
            "experience" : "신입",
            "preferential" : ["임베디드SW", "영어가능자"]
        }
    ],
    "신세계아이앤씨" : [
        {
            "title" : "SW Develop & Operation ",
            "required_skills" : ["java", "c", "c++", "python", "mysql", "R"],
            "experience" : "경력3년이상",
            "preferential" : ["AI챗봇", "doker", "kubernetes", "container기반서비스"]
        }
    ],
    "미디어로그" : [
        {
            "title" : "SW Developer",
            "required_skills" : ["java"],
            "experience" : "신입",
            "preferential" : ["대졸"]
        }
    ],
    "현대이지웰" : [
        {
            "title" : "SW Developer",
            "required_skills" : ["java", "jsp", "jquery", "spring", "strutus2", "mybatis"],
            "experience" : ["신입", "경력2년이상"],
            "preferential" : ["대졸"]
        }
    ],
    "비지에프리테일" : [
        {
            "title" : "하계 채용연계형 인턴",
            "required_skills" : ["java", "jsp", "javascript", "nexacro", "html5"],
            "experience" : ["신입"],
            "preferential" : ["대졸", "학점3점이상"]
        }
    ],
    "넥슨" : [
        {
            "title" : "탐지응용팀 백엔드 개발자",
            "required_skills" : ["python", "kafka", "apache flink", "react(next.js)", "vue", "mysql", "redis"],
            "experience" : ["신입"],
            "preferential" : ["lac경험자", "데이터분석", "실시간스트림처리"]
        }
    ],
    "한국소니전자" : [
        {
            "title" : "설비 소프트웨어 개발",
            "required_skills" : ["c#", "visualbasic"],
            "experience" : ["신입"],
            "preferential" : ["컴퓨터/시스템공학", "jlpt n4이상"]
        }
    ],
    "NHN KCP" : [
        {
            "title" : "PG정산시스템 개발 및 운영",
            "required_skills" : ["java", "c", "oracle"],
            "experience" : ["신입", "경력2년"],
            "preferential" : ["대용량데이터처리"]
        }
    ],
    "테스트뱅크" : [
        {
            "title" : "Backend Developer",
            "required_skills" : ["mysql", "git"],
            "experience" : ["신입"],
            "preferential" : ["golang", "docker", "DB"]
        }
    ],
    "페이타랩" : [
        {
            "title" : "Android Developer",
            "required_skills" : ["kotlin", "java"],
            "experience" : ["신입"],
            "preferential" : ["AOS"]
        },
        {
            "title" : "Web Front End Developer",
            "required_skills" : ["typescript", "javascript", "html", "css", "react", "webpack", "git"],
            "experience" : ["신입"],
            "preferential" : ["ui", "ux"]
        }
    ],
    "이니텍" : [
        {
            "title" : "Backend Developer",
            "required_skills" : ["golang", "fiber", "sentry", "jira"],
            "experience" : ["경력6년이상"],
            "preferential" : ["대졸"]
        }
    ],
    "카카오페이증권" : [
        {
            "title" : "워크플랫폼 개발자",
            "required_skills" : ["java", "kotlin", "springboot", "mysql"],
            "experience" : ["경력3년이상"],
            "preferential" : ["docker", "kubernetes"]
        }
    ],
    "DB Int" : [
        {
            "title" : "SW Engineer",
            "required_skills" : ["java", "c"],
            "experience" : ["신입"],
            "preferential" : ["개발경험", "자격증"]
        },
        {
            "title" : "Infra Engineer",
            "required_skills" : ["네트워크"],
            "experience" : ["신입"],
            "preferential" : ["OSI 7 Layer", "TCP/IP", "Routing & Switching", "케이블링", "packet"]
        },
    ],
    "카카오엔터테인먼트" : [
        {
            "title" : "Android Developer",
            "required_skills" : ["java", "kotlin"],
            "experience" : ["경력4년이상"],
            "preferential" : ["RxJava", "RxKotlin", "coroutine", "MVVM", "MVI", "Epub", "ExoPlayer Custom"]
        },
        {
            "title" : "iOS Developer",
            "required_skills" : ["swift", "object-c", "git"],
            "experience" : ["경력10년이하"],
            "preferential" : ["xib", "storyboard", "autolayout"]
        }
    ],
    "카카오뱅크" : [
        {
            "title" : "Server Developer",
            "required_skills" : ["java", "springframework", "restAPI"],
            "experience" : ["경력3년이상"],
            "preferential" : ["kafka", "rabbitmq", "nosql"]
        }
    ],
    "sk쉴더스" : [
        {
            "title" : "빅데이터 엔진 개발",
            "required_skills" : ["scala", "spark", "hadoop", "hive"],
            "experience" : ["경력5년이상"],
            "preferential" : ["docker", "kubernetes", "대규모 실시간 스트리밍 데이터 처리"]
        }
    ],
    "파인더스" : [
        {
            "title" : "GPT 챗봇 개발자",
            "experience" : ["신입"],
            "required_skills" : ["pytorch", "python", "tensorflow", "json"],
            "preferential" : ["챗봇", "NLG"]
        }
    ],
    "이스트게임즈" : [
        {
            "title" : "Web Full Stack Developer",
            "experience" : ["신입"],
            "required_skills" : ["django", "react", "spring", "python", "java", "javascript"],
            "preferential" : ["typescript", "restAPI", "Graphql", "springframework", "AWS"]
        }
    ],
    "KT NexR" : [
        {
            "title" : "Front End Developer",
            "experience" : ["경력8년이상"],
            "required_skills" : ["javascript", "figma", "vue.js", "html5", "css", "javascript"],
            "preferential" : ["hadoop", "webpack", "rollup"]
        }
    ]
}

skill_stack = {
    "언어" : ["java", "python", "c++", "c", "kotlin", "swift", "object-c", "javascript", "typescript", "R", "scala", "html", "css"],
    "프론트엔드" : ["react", "angular", "vuejs", "nextjs", "svelte"],
    "백엔드" : ["spring", "springboot", "nodejs", "flask", "django", "ruby on rails"],
    "데이터" : ["kafka", "hadoop", "spark", "pytorch", "flink", "tensorflow", "hive", "base"],
    "데이터베이스" : ["mongodb", "mysql", "cassandradb", "redis", "elasticsearch", "mariadb", "oracledb"]
}

recommend_projects = {
    "언어 학습 앱" : [
        {
            "기술" : ["java", "python", "kotlin", "swift", "react", "flask", "mongodb"],
            "내용" : "다국어 학습 앱을 개발하여 사용자가 자신의 언어 능력 향상 도움 앱"
        }
    ],
    "AI기반 음악 추천 시스템" : [
        {
            "기술" : ["python", "tensorflow", "pytorch", "mongodb", "redis", "elasticsearch"],
            "내용" : "사용자의 음악 취향을 분석하고, 인공지능 모델을 활용하여 개인 맞춤형 음악 추천 시스템"
        },
    ],
    "개인 포트폴리오 웹사이트" : [
        {
            "기술" : ["react", "typescript", "nodejs", "express", "mongodb"],
            "내용" : "개발자 또는 디자이너로서 자신의 작업물을 개시하고, 이력서 및 연락처 정보를 제공하는 개인 웹사이트 구축"
        },
    ],
    "건강 관리 앱" : [
        {
            "기술" : ["flutter", "swift", "kotlin", "nodejs", "AWS", "figma", "firebase", "tensorflow"],
            "내용" : "사용자의 식습관과 활동량 데이터를 인공지능을 활용하여 개인의 건강 상태를 추적/관리하고 건강 조언 제공 앱"
        }
    ],
    "음식 및 레시피 추천 챗봇" : [
        {
            "기술" : ["react", "flask", "django", "mongodb", "mysql", "tensorflow", "pytorch"],
            "내용" : "사용자의 식습관과 취향에 맞춰 음식 및 요리 레시피를 추천하여 식사 계획을 도와주는 플랫폼"
        }
    ],
    "로그 분석 및 알림 시스템" : [
        {
            "기술" : ["kafka", "mongodb", "cassandradb", "elasticsearch", "nltk", "react", "flask","angular", "azure", "tensorflow"],
            "내용" : "소셜 미디어 플랫폼의 데이터를 수집하고 분석하여 특정 주제에 대한 실시간 트랜드 및 감성 분석을 수행하는 시스템을 통해 뉴스 및 소셜 미디어의 핫 토픽을 실시간으로 추적"
        }
    ],
    "e러닝 플랫폼 강의 추천 시스템" : [
        {
            "기술" : ["kafka", "hadoop", "python", "tensorflow", "spark", "flask", "nltk", "jwt"],
            "내용" : "학습자의 학습 기록, 관심 분야, 성취도 등을 분석하여 e러닝 플랫폼에서 강의를 추천하는 시스템"
        }
    ]
}

def count_matching_elements(list1, list2):
    return len(set(list1) & set(list2))

def process_user_input(user_form_data):
    user_info = {
        "name": user_form_data["name"],
        "experience": user_form_data["experience"],
        "skills": user_form_data["skills"].split(", "),
        "desired_company": user_form_data["desired_company"],
        "certification": user_form_data["certification"].split(", ")
    }
    
    language = {}
    for key, value in user_form_data.items():
        if key.startswith("language_name") and value:
            language_scores_key = f"language_scores_{key.split('_')[-1]}"
            language_scores = user_form_data.get(language_scores_key, "")
            if language_scores:
                language[value] = language_scores
    user_info["languages"] = language  # 변경된 부분

    
    project = {}
    for key, value in user_form_data.items():
        if key.startswith("project_name") and value:
            project_skill_key = f"project_skill_{key.split('_')[-1]}"
            project_skill = user_form_data.get(project_skill_key, "")
            if project_skill:
                project[value] = project_skill
    user_info["projects"] = project
    
    activity = {}
    for key, value in user_form_data.items():
        if key.startswith("activity_name") and value:
            activity_subject_key = f"activity_subject_{key.split('_')[-1]}"
            activity_subject = user_form_data.get(activity_subject_key, "")
            if activity_subject:
                activity[value] = activity_subject
    user_info["activities"] = activity
    
    result = {
        "user_info": user_info,
        "recommended_companies": recommended_companies(user_info),
        "desired_company_results": desired_company_results(user_info),
        "recommended_projects": recommended_projects(user_info)
    }
    return result

def compare_company_posting(company_posting, user_info):
    company_required_skills = set(company_posting.get('required_skills', []))
    company_preferential_skills = set(company_posting.get('preferential', []))
    
    matching_required_skills = count_matching_elements(user_info['skills'], company_required_skills)
    matching_preferential_skills = count_matching_elements(user_info['skills'], company_preferential_skills)
    
    required_score = (matching_required_skills / len(company_required_skills)) * 100
    preferential_score = (matching_preferential_skills / len(company_preferential_skills)) * 100
    
    preferential_skills = list(company_preferential_skills)
    
    return required_score, preferential_score, preferential_skills

def recommended_companies(user_info):
    recommended_companies = []
    for company, postings in companies.items():
        for posting in postings:
            required_score, preferential_score, preferential_skills = compare_company_posting(posting, user_info)
            if required_score >= 50:
                recommended_companies.append({
                    "company": company,
                    "title" : posting["title"],
                    "required_score": required_score,
                    "preferential_score": preferential_score,
                    "preferential_skills": preferential_skills
                })
    recommended_companies.sort(key=lambda x: x['preferential_score'], reverse=True)
    return recommended_companies

def desired_company_results(user_info):
    desired_company = user_info["desired_company"]
    if desired_company in companies:
        desired_company_results = {}
        postings = companies[desired_company]
        for posting in postings:
            required_score, preferential_score, preferential_skills = compare_company_posting(posting, user_info)
            desired_company_results[posting["title"]] = {
            "company" : desired_company,
            "required_score": required_score,
            "preferential_score": preferential_score,
            "preferential_skills": preferential_skills
        }

        return desired_company_results
    else :
        return None

def recommended_projects(user_info):
    user_skills = user_info['skills']
    recommended_projects_list = []

    for project_category, project_list in recommend_projects.items():
        for project_info in project_list:
            project_skills = project_info['기술']

            for subcategory_skills in project_info.values():
                if isinstance(subcategory_skills, list):
                    project_skills.extend(subcategory_skills)

            unmatched_skills = set(project_skills) | set(user_skills)
            if len(unmatched_skills) > 0:
                recommended_projects_list.append({
                    "category": project_category,
                    "unmatched_skills": list(unmatched_skills),
                    "projects": project_info['내용']
                })

    return recommended_projects_list
